
#include "MCP4716Drv.h"

//#define NUM_ELEMENTS 2173
#include "16bit_signed_Open1.h"


const int16_t sine_wave[360]={
    0, 87, 174, 262, 349, 436, 523, 609, 696, 782, 868, 954, 1040, 1125, 1210, 1294, 1378, 
    1462, 1545, 1628, 1710, 1792, 1873, 1954, 2034, 2113, 2192, 2270, 2347, 2424, 2500, 2575, 
    2650, 2723, 2796, 2868, 2939, 3009, 3078, 3147, 3214, 3280, 3346, 3410, 3473, 3536, 3597, 
    3657, 3716, 3774, 3830, 3886, 3940, 3993, 4045, 4096, 4145, 4193, 4240, 4286, 4330, 4373, 
    4415, 4455, 4494, 4532, 4568, 4603, 4636, 4668, 4698, 4728, 4755, 4782, 4806, 4830, 4851, 
    4872, 4891, 4908, 4924, 4938, 4951, 4963, 4973, 4981, 4988, 4993, 4997, 4999, 5000, 4999, 
    4997, 4993, 4988, 4981, 4973, 4963, 4951, 4938, 4924, 4908, 4891, 4872, 4851, 4830, 4806, 
    4782, 4755, 4728, 4698, 4668, 4636, 4603, 4568, 4532, 4494, 4455, 4415, 4373, 4330, 4286, 
    4240, 4193, 4145, 4096, 4045, 3993, 3940, 3886, 3830, 3774, 3716, 3657, 3597, 3536, 3473, 
    3410, 3346, 3280, 3214, 3147, 3078, 3009, 2939, 2868, 2796, 2723, 2650, 2575, 2500, 2424, 
    2347, 2270, 2192, 2113, 2034, 1954, 1873, 1792, 1710, 1628, 1545, 1462, 1378, 1294, 1210, 
    1125, 1040, 954, 868, 782, 696, 609, 523, 436, 349, 262, 174, 87, 0, -87, -174, -262, -349, 
    -436, -523, -609, -696, -782, -868, -954, -1040, -1125, -1210, -1294, -1378, -1462, -1545, 
    -1628, -1710, -1792, -1873, -1954, -2034, -2113, -2192, -2270, -2347, -2424, -2500, -2575, 
    -2650, -2723, -2796, -2868, -2939, -3009, -3078, -3147, -3214, -3280, -3346, -3410, -3473, 
    -3536, -3597, -3657, -3716, -3774, -3830, -3886, -3940, -3993, -4045, -4096, -4145, -4193, 
    -4240, -4286, -4330, -4373, -4415, -4455, -4494, -4532, -4568, -4603, -4636, -4668, -4698, 
    -4728, -4755, -4782, -4806, -4830, -4851, -4872, -4891, -4908, -4924, -4938, -4951, -4963, 
    -4973, -4981, -4988, -4993, -4997, -4999, -5000, -4999, -4997, -4993, -4988, -4981, -4973, 
    -4963, -4951, -4938, -4924, -4908, -4891, -4872, -4851, -4830, -4806, -4782, -4755, -4728, 
    -4698, -4668, -4636, -4603, -4568, -4532, -4494, -4455, -4415, -4373, -4330, -4286, -4240, 
    -4193, -4145, -4096, -4045, -3993, -3940, -3886, -3830, -3774, -3716, -3657, -3597, -3536, 
    -3473, -3410, -3346, -3280, -3214, -3147, -3078, -3009, -2939, -2868, -2796, -2723, -2650, 
    -2575, -2500, -2424, -2347, -2270, -2192, -2113, -2034, -1954, -1873, -1792, -1710, -1628, 
    -1545, -1462, -1378, -1294, -1210, -1125, -1040, -954, -868, -782, -696, -609, -523, -436, 
    -349, -262, -174, -87
};

uint8_t WaveEnable = 0,wavecycle=0;

//extern const signed int wavedata1[NUM_ELEMENTS];

void PlaySineWave(void)
{
    static uint16_t wavecount = 0;
    uint32_t val;
    if (WaveEnable == 0)
    {
        wavecount = 0;
        return;
    }
    
    val = (uint32_t)32768 + wavedata1[wavecount];
    val >>= 6;
    DAC_Write_VolatileRegVal(val);

    wavecount++;
    if (wavecount >= NUM_ELEMENTS)
    {
        wavecount = 0;
        wavecycle++;
        if(wavecycle > 0)
        {
            WaveEnable = 0;
            wavecount = 0;
            LPIT_DRV_StopTimerChannels(INST_LPIT1, (1 << 1));
        }
    }
    
}

void StartWave(void)
{
    WaveEnable = 1;
    wavecycle = 0;
    LPIT_DRV_StartTimerChannels(INST_LPIT1, (1 << 1));
}


void DAC_Init(void)
{
    
}

uint8_t DAC_Write_VolatileRegVal(uint16_t val)
{
	uint8_t ret,txbuf_temp[2];
	txbuf_temp[0]=val>>6;//get data
	txbuf_temp[1]=(val&0x3f)<<2;//get data
	txbuf_temp[0]=(txbuf_temp[0]&0x0F);//Add command bits
    LPI2C_DRV_MasterSetSlaveAddr(INST_LPI2C1,0x60,false);
	ret = LPI2C_DRV_MasterSendData(INST_LPI2C1, txbuf_temp, 2, true);
	//ret = LPI2C_DRV_MasterSendDataBlocking(INST_LPI2C1, txbuf_temp, 2, true, 10);
    //ret = I2C_1_I2CMasterWriteBuf(0x60,txbuf_temp, 2u,I2C_1_I2C_MODE_COMPLETE_XFER);
	return ret;
}

